name: Clash-for-Windows Update Check

on:

  workflow_dispatch:


jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Set python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install requirements
      run: pip install pyyaml requests

    - name: Get current version
      id: current_version
      run: |
        import yaml
        import requests
        header = {
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
        'Accept-Encoding': 'gzip, deflate', 'Accept-Language': 'zh-CN,zh;q=0.9', 'Connection': 'keep-alive',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.54 Safari/537.36'}
        r = requests.get(https://api.github.com/repos/Fndroid/clash_for_windows_pkg/releases/latest, headers=header)
        metadata = yaml.safe_load(r.content)
        version = metadata[0]['tag_name']
        version = version[1:]

        print(f'::set-output name=current_version::{version}')
        
    - name: Set clash version
      run: echo "CLASH_VERSION=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_ENV
          
    - name: Publish to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          Clash for Windows 更新啦！
          版本：${{ env.CLASH_VERSION }}
  # 更新日志：${{ steps.github.outputs.changelog }}
    

        
 
