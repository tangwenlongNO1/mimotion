name: Clash-for-Windows Update Check

on:

  workflow_dispatch:
env:
  CLASH_URL: https://github.com/Fndroid/clash_for_windows_pkg/releases/latest

jobs:
  update:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Get latest Clash for Windows release
      id: clash
      uses: wei/curl@master
      with:
        args: -sSL https://api.github.com/repos/Fndroid/clash_for_windows_pkg/releases/latest
    
    - name: Get version and changelog
      id: github
      run: |
        version=$(echo ${{ steps.clash.outputs.data }} | jq -r '.tag_name')
        changelog=$(echo ${{ steps.clash.outputs.data }} | jq -r '.body' | sed 's/\n/ /g')
        echo "Version: $version"
        echo "Changelog: $changelog"
        echo "::set-output name=version::$version"
        echo "::set-output name=changelog::$changelog"
          
    - name: Publish to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          Clash for Windows 更新啦！
          版本：${{ steps.github.outputs.version }}
          更新日志：${{ steps.github.outputs.changelog }}

        
 
