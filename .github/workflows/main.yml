name: Clash-for-Windows Update Check

on:

  workflow_dispatch:


jobs:
  update:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Set python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install requirements
      run: pip install pyyaml requests

    - name: Get current version
      id: current_version
      run: |
        import yaml
        import requests
        
        r = requests.get('https://api.github.com/repos/Fndroid/clash_for_windows_pkg/releases/latest')
        metadata = yaml.safe_load(r.content)
        version = metadata[0]['tag_name']
        version = version[1:]

        print(f'::set-output name=current_version::{version}')
        
    - name: Set clash version
      run: echo "CLASH_VERSION=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_ENV
          
    - name: Publish to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          Clash for Windows 更新啦！
          版本：${{ env.CLASH_VERSION }}
  # 更新日志：${{ steps.github.outputs.changelog }}
    

        
 
